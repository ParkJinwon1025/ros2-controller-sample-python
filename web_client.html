<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ROS2 Web Monitor</title>
    <script src="https://unpkg.com/roslib@1.3.0/build/roslib.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: white; text-align: center; margin-bottom: 20px; }

        .section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }

        .json-container {
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }
        .json-header {
            background: #f8f9fa;
            padding: 8px 12px;
            font-weight: bold;
        }
        .json-display {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 12px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover { background: #5568d3; }

        input {
            padding: 6px;
            margin: 3px;
            width: 80px;
        }

        .message-log {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
        }

        .message {
            background: #f0f0f0;
            margin: 4px 0;
            padding: 6px;
            border-radius: 4px;
            font-size: 13px;
        }
        .topic { border-left: 4px solid #28a745; }
        .service { border-left: 4px solid #ffc107; }

        .time { color: #777; font-size: 0.85em; }
    </style>
</head>

<body>
<div class="container">
    <h1>üì° ROS2 Web Monitor</h1>

    <div class="section">
        <div id="status" class="status disconnected">Connecting...</div>
    </div>

    <!-- ================= Topic ================= -->
    <div class="section">
        <h2>üìç Topic : /position_topic</h2>

        <input id="pub_x" type="number" step="0.1" value="5">
        <input id="pub_y" type="number" step="0.1" value="3">
        <input id="pub_z" type="number" step="0.1" value="2">
        <input id="pub_angle" type="number" step="0.1" value="45">
        <button onclick="publishPosition()">Publish</button>

        <div class="json-container">
            <div class="json-header">üì§ Sent JSON</div>
            <div id="topic-sent" class="json-display">ÎåÄÍ∏∞ Ï§ë...</div>
        </div>

        <div class="json-container">
            <div class="json-header">üì• Received JSON</div>
            <div id="topic-received" class="json-display">ÎåÄÍ∏∞ Ï§ë...</div>
        </div>

        <div id="topic-log" class="message-log"></div>
    </div>

    <!-- ================= Service ================= -->
    <div class="section">
        <h2>üìû Service : /calculate_distance</h2>

        <input id="x1" type="number" value="0">
        <input id="y1" type="number" value="0">
        <input id="z1" type="number" value="0">

        <input id="x2" type="number" value="10">
        <input id="y2" type="number" value="10">
        <input id="z2" type="number" value="5">

        <button onclick="callService()">Calculate</button>

        <div class="json-container">
            <div class="json-header">üì• Response JSON</div>
            <div id="service-response" class="json-display">ÎåÄÍ∏∞ Ï§ë...</div>
        </div>

        <div id="service-log" class="message-log"></div>
    </div>
</div>

<script>
/* ================= Í∏∞Î≥∏ ÏÑ§Ï†ï ================= */
const ROSBRIDGE_PORT = 9090;
const rosbridgeUrl = `ws://${location.hostname}:${ROSBRIDGE_PORT}`;

let ros;
let topicListener;
let positionPublisher;

/* ================= Ïú†Ìã∏ ================= */
function pretty(obj) {
    return JSON.stringify(obj, null, 2);
}

function addLog(containerId, text, type) {
    const div = document.createElement('div');
    div.className = `message ${type}`;
    div.innerHTML = `<span class="time">[${new Date().toLocaleTimeString()}]</span> ${text}`;
    document.getElementById(containerId).prepend(div);
}

/* ================= ROS Ïó∞Í≤∞ ================= */
function connectROS() {
    ros = new ROSLIB.Ros({ url: rosbridgeUrl });

    ros.on('connection', () => {
        document.getElementById('status').textContent = '‚úÖ Connected';
        document.getElementById('status').className = 'status connected';
        setupROS();
    });

    ros.on('error', (err) => {
        console.error(err);
    });

    ros.on('close', () => {
        document.getElementById('status').textContent = '‚ö†Ô∏è Reconnecting...';
        document.getElementById('status').className = 'status disconnected';
        setTimeout(connectROS, 2000);
    });
}

/* ================= Topic / Publisher ================= */
function setupROS() {
    topicListener = new ROSLIB.Topic({
        ros,
        name: '/position_topic',
        messageType: 'test_interfaces/msg/Position'
    });

    positionPublisher = new ROSLIB.Topic({
        ros,
        name: '/position_topic',
        messageType: 'test_interfaces/msg/Position'
    });

    topicListener.subscribe(msg => {
        document.getElementById('topic-received').textContent = pretty(msg);
        addLog('topic-log', `Received x=${msg.x}, y=${msg.y}`, 'topic');
    });
}

function publishPosition() {
    const msg = {
        sender: 'Web',
        x: Number(pub_x.value),
        y: Number(pub_y.value),
        z: Number(pub_z.value),
        angle: Number(pub_angle.value),
        timestamp: Date.now()
    };

    document.getElementById('topic-sent').textContent = pretty(msg);
    positionPublisher.publish(new ROSLIB.Message(msg));
    addLog('topic-log', 'Published message', 'topic');
}

/* ================= Service ================= */
function callService() {
    const client = new ROSLIB.Service({
        ros,
        name: '/calculate_distance',
        serviceType: 'test_interfaces/srv/CalculateDistance'
    });

    const request = {
        x1: Number(x1.value), y1: Number(y1.value), z1: Number(z1.value),
        x2: Number(x2.value), y2: Number(y2.value), z2: Number(z2.value)
    };

    client.callService(
        new ROSLIB.ServiceRequest(request),
        (res) => {
            document.getElementById('service-response').textContent = pretty(res);
            addLog('service-log', `Distance = ${res.distance}`, 'service');
        },
        () => {
            addLog('service-log', 'Service call failed', 'service');
        }
    );
}

/* ================= ÏãúÏûë ================= */
connectROS();
</script>
</body>
</html>
